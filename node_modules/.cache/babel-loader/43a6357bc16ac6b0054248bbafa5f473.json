{"ast":null,"code":"/*\n * @copyright\n * Copyright © Microsoft Open Technologies, Inc.\n *\n * All Rights Reserved\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http: *www.apache.org/licenses/LICENSE-2.0\n *\n * THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS\n * OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION\n * ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A\n * PARTICULAR PURPOSE, MERCHANTABILITY OR NON-INFRINGEMENT.\n *\n * See the Apache License, Version 2.0 for the specific language\n * governing permissions and limitations under the License.\n */\n'use strict';\n\nvar _ = require('underscore');\n\nrequire('date-utils'); // Adds a number of convenience methods to the builtin Date object.\n\n\nvar querystring = require('querystring');\n\nvar uuid = require('uuid');\n\nvar request = require('request');\n\nvar url = require('url');\n\nvar async = require('async');\n\nvar constants = require('./constants');\n\nvar Logger = require('./log').Logger;\n\nvar util = require('./util');\n\nvar OAuth2Parameters = constants.OAuth2.Parameters;\nvar OAuth2ResponseParameters = constants.OAuth2.ResponseParameters;\nvar DeviceCodeResponseParameters = constants.OAuth2.DeviceCodeResponseParameters;\nvar IdTokenMap = constants.OAuth2.IdTokenMap;\nvar TokenResponseFields = constants.TokenResponseFields;\nvar UserCodeResponseFields = constants.UserCodeResponseFields;\nvar IdTokenFields = constants.IdTokenFields;\nvar TOKEN_RESPONSE_MAP = {};\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.TOKEN_TYPE] = TokenResponseFields.TOKEN_TYPE;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ACCESS_TOKEN] = TokenResponseFields.ACCESS_TOKEN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.REFRESH_TOKEN] = TokenResponseFields.REFRESH_TOKEN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.CREATED_ON] = TokenResponseFields.CREATED_ON;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.EXPIRES_ON] = TokenResponseFields.EXPIRES_ON;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.EXPIRES_IN] = TokenResponseFields.EXPIRES_IN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.RESOURCE] = TokenResponseFields.RESOURCE;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ERROR] = TokenResponseFields.ERROR;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ERROR_DESCRIPTION] = TokenResponseFields.ERROR_DESCRIPTION;\nvar DEVICE_CODE_RESPONSE_MAP = {};\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.DEVICE_CODE] = UserCodeResponseFields.DEVICE_CODE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.USER_CODE] = UserCodeResponseFields.USER_CODE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.VERIFICATION_URL] = UserCodeResponseFields.VERIFICATION_URL;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.INTERVAL] = UserCodeResponseFields.INTERVAL;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.EXPIRES_IN] = UserCodeResponseFields.EXPIRES_IN;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.MESSAGE] = UserCodeResponseFields.MESSAGE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.ERROR] = UserCodeResponseFields.ERROR;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.ERROR_DESCRIPTION] = UserCodeResponseFields.ERROR_DESCRIPTION;\n/**\n * Constructs an instances of OAuth2Client\n * @constructor\n * @private\n * @param {object} callContext Contains any context information that applies to the request.\n * @param {string|url} authority  An url that points to an authority.\n */\n\nfunction OAuth2Client(callContext, authority) {\n  this._aadApiVersion = authority.aadApiVersion === undefined ? '1.0' : authority.aadApiVersion;\n  this._tokenEndpoint = authority.tokenEndpoint;\n  this._deviceCodeEndpoint = authority.deviceCodeEndpoint;\n  this._log = new Logger('OAuth2Client', callContext._logContext);\n  this._callContext = callContext;\n  this._cancelPollingRequest = false;\n}\n/**\n * Constructs an OAuth 2.0 token request url.\n * @private\n * @return {URL}\n */\n\n\nOAuth2Client.prototype._createTokenUrl = function () {\n  var tokenUrl = url.parse(this._tokenEndpoint);\n  var parameters = {};\n  parameters[OAuth2Parameters.AAD_API_VERSION] = this._aadApiVersion;\n  tokenUrl.search = querystring.stringify(parameters);\n  return tokenUrl;\n};\n/**\n * Constructs the user code info request url. \n * @private \n * @return {URL}\n */\n\n\nOAuth2Client.prototype._createDeviceCodeUrl = function () {\n  var deviceCodeUrl = url.parse(this._deviceCodeEndpoint);\n  var parameters = {};\n  parameters[OAuth2Parameters.AAD_API_VERSION] = this._aadApiVersion;\n  deviceCodeUrl.search = querystring.stringify(parameters);\n  return deviceCodeUrl;\n};\n/**\n * @private\n * @param {object}   obj         An object in which integer values may reside.\n * @param {array}    keys        An array of strings that specify keys in which integers may need parsing.\n */\n\n\nOAuth2Client.prototype._parseOptionalInts = function (obj, keys) {\n  var self = this;\n  keys.forEach(function (element) {\n    if (_.has(obj, element)) {\n      obj[element] = parseInt(obj[element], 10);\n\n      if (isNaN(obj[element])) {\n        throw self._log.createError(element + ' could not be parsed as an int.');\n      }\n    }\n  });\n};\n/**\n * Parses a JWS encoded JWT into it's three parts.\n * @param  {string} jwtToken The token to parse.\n * @return {object}          The three JWS parts, header, JWSPayload, and JWSSig, or undefined.\n */\n\n\nOAuth2Client.prototype._crackJwt = function (jwtToken) {\n  var idTokenPartsRegex = /^([^\\.\\s]*)\\.([^\\.\\s]+)\\.([^\\.\\s]*)$/;\n  var matches = idTokenPartsRegex.exec(jwtToken);\n\n  if (!matches || matches.length < 4) {\n    this._log.warn('The returned id_token is not parseable.');\n\n    return;\n  }\n\n  var crackedToken = {\n    header: matches[1],\n    JWSPayload: matches[2],\n    JWSSig: matches[3]\n  };\n  return crackedToken;\n};\n/**\n * Finds the value that should be used as the userId value.\n * @param {object} idToken The id token that parsed.\n * @returns {object} An object with a userId field and maybe a userIdIsDisplayable field.\n */\n\n\nOAuth2Client.prototype._getUserId = function (idToken) {\n  var userId;\n  var isDisplayable;\n\n  if (idToken.upn) {\n    userId = idToken.upn;\n    isDisplayable = true;\n  } else if (idToken.email) {\n    userId = idToken.email;\n    isDisplayable = true;\n  } else if (idToken.sub) {\n    userId = idToken.sub;\n  }\n\n  if (!userId) {\n    // generate a random GUID.\n    userId = uuid.v4();\n  }\n\n  var userIdVals = {};\n  userIdVals[IdTokenFields.USER_ID] = userId;\n\n  if (isDisplayable) {\n    userIdVals[IdTokenFields.IS_USER_ID_DISPLAYABLE] = true;\n  }\n\n  return userIdVals;\n};\n\nfunction mapFields(inObj, outObj, map) {\n  for (var key in inObj) {\n    if (map[key]) {\n      var mappedKey = map[key];\n      outObj[mappedKey] = inObj[key];\n    }\n  }\n}\n/**\n * Given a decoded id token off the wire, this function extracts the values that\n * ADAL commonly returns to callers and translates the names to more user\n * friendly names.\n * @param  {Object} idToken A decoded id token.\n * @return {Object}         The set of extracted values with their new names.\n */\n\n\nOAuth2Client.prototype._extractIdTokenValues = function (idToken) {\n  var extractedValues = {};\n\n  _.extend(extractedValues, this._getUserId(idToken));\n\n  mapFields(idToken, extractedValues, IdTokenMap);\n  return extractedValues;\n};\n/**\n * Parses the value of the id_token OAuth 2 Reponse.\n * @param  {string} encodedIdToken An unencrypted JWT token.\n * @return {object}                 returns the decoded id_token or undefined.\n */\n\n\nOAuth2Client.prototype._parseIdToken = function (encodedIdToken) {\n  var crackedToken = this._crackJwt(encodedIdToken);\n\n  if (!crackedToken) {\n    return;\n  }\n\n  var idToken;\n\n  try {\n    var base64IdToken = crackedToken.JWSPayload;\n    var base64Decoded = util.base64DecodeStringUrlSafe(base64IdToken);\n\n    if (!base64Decoded) {\n      this._log.warn('The returned id_token could not be base64 url safe decoded.');\n\n      return;\n    }\n\n    idToken = JSON.parse(base64Decoded);\n  } catch (err) {\n    this._log.warn('the returned id_token could not be decoded');\n\n    this._log.warn('The returned id_token could not be decoded: ' + err.stack, true);\n\n    return;\n  }\n\n  return this._extractIdTokenValues(idToken);\n};\n/**\n * Validates the response returned from an OAuth 2.0 token request.\n * @private\n * @param  {string} body  The response as a string encoded JSON object.\n * @return {object}       The parsed response.\n */\n\n\nOAuth2Client.prototype._validateTokenResponse = function (body) {\n  var wireResponse;\n  var tokenResponse = {};\n\n  try {\n    wireResponse = JSON.parse(body);\n  } catch (e) {\n    throw new Error('The token response returned from the server is unparseable as JSON');\n  }\n\n  var intKeys = [OAuth2ResponseParameters.EXPIRES_ON, OAuth2ResponseParameters.EXPIRES_IN, OAuth2ResponseParameters.CREATED_ON];\n\n  this._parseOptionalInts(wireResponse, intKeys);\n\n  if (wireResponse[OAuth2ResponseParameters.EXPIRES_IN]) {\n    var expiresIn = wireResponse[OAuth2ResponseParameters.EXPIRES_IN];\n    var now = new Date();\n    wireResponse[OAuth2ResponseParameters.EXPIRES_ON] = now.add({\n      seconds: expiresIn\n    });\n  }\n\n  if (wireResponse[OAuth2ResponseParameters.CREATED_ON]) {\n    var tempDate = new Date();\n    var createdOn = wireResponse[OAuth2ResponseParameters.CREATED_ON];\n    tempDate.setTime(createdOn);\n    wireResponse[OAuth2ResponseParameters.CREATED_ON] = tempDate;\n  }\n\n  if (!wireResponse[OAuth2ResponseParameters.TOKEN_TYPE]) {\n    throw this._log.createError('wireResponse is missing token_type');\n  }\n\n  if (!wireResponse[OAuth2ResponseParameters.ACCESS_TOKEN]) {\n    throw this._log.createError('wireResponse missing access_token');\n  }\n\n  mapFields(wireResponse, tokenResponse, TOKEN_RESPONSE_MAP);\n\n  if (wireResponse[OAuth2ResponseParameters.ID_TOKEN]) {\n    var idToken = this._parseIdToken(wireResponse[OAuth2ResponseParameters.ID_TOKEN]);\n\n    if (idToken) {\n      _.extend(tokenResponse, idToken);\n    }\n  }\n\n  return tokenResponse;\n};\n/**\n * Validates the response returned from an OAuth 2.0 device code request.\n * @private\n * @param  {string} body  The response as a string encoded JSON object.\n * @return {object}       The parsed response.\n */\n\n\nOAuth2Client.prototype._validateDeviceCodeResponse = function (body) {\n  var wireResponse;\n  var deviceCodeResponse = {};\n\n  try {\n    wireResponse = JSON.parse(body);\n  } catch (e) {\n    throw new Error('The device code response returned from the server is unparseable as JSON.');\n  }\n\n  var intKeys = [DeviceCodeResponseParameters.EXPIRES_IN, DeviceCodeResponseParameters.INTERVAL];\n\n  this._parseOptionalInts(wireResponse, intKeys);\n\n  if (!wireResponse[DeviceCodeResponseParameters.EXPIRES_IN]) {\n    throw this._log.createError('wireResponse is missing expires_in');\n  }\n\n  if (!wireResponse[DeviceCodeResponseParameters.DEVICE_CODE]) {\n    throw this._log.createError('wireResponse is missing device code');\n  }\n\n  if (!wireResponse[DeviceCodeResponseParameters.USER_CODE]) {\n    throw this._log.createError('wireResponse is missing user code');\n  }\n\n  mapFields(wireResponse, deviceCodeResponse, DEVICE_CODE_RESPONSE_MAP);\n  return deviceCodeResponse;\n};\n/**\n * @private\n * @param {string}                   body        The body of a http token response.\n */\n\n\nOAuth2Client.prototype._handlePollingResponse = function (body) {\n  //handle token error response\n  var tokenResponse = this._handlePollingRequestErrorResponse(body);\n\n  if (_.isEmpty(tokenResponse)) {\n    tokenResponse = this._validateTokenResponse(body);\n  }\n\n  return tokenResponse;\n};\n/**\n * @private\n * @param {string}                   body        The body of a http token response.\n */\n\n\nOAuth2Client.prototype._handlePollingRequestErrorResponse = function (body) {\n  var wireResponse;\n  var tokenResponse = {};\n\n  try {\n    wireResponse = JSON.parse(body);\n  } catch (e) {\n    throw new Error('The token response returned from the server is unparsable as JSON');\n  }\n\n  if (wireResponse[OAuth2ResponseParameters.ERROR]) {\n    mapFields(wireResponse, tokenResponse, TOKEN_RESPONSE_MAP);\n  }\n\n  return tokenResponse;\n};\n/**\n * @private\n * @param {object}                   response    An http response object.\n * @param {string}                   body        The body of a http token response.\n * @param {OAuth2Client.GetTokenCallback}    callback    A call back function.  The body parameter is the body parameter passed\n *                                               into this function.\n */\n\n\nOAuth2Client.prototype._handleGetTokenResponse = function (response, body, callback) {\n  var tokenResponse;\n\n  try {\n    tokenResponse = this._validateTokenResponse(body);\n  } catch (e) {\n    this._log.error('Error validating get token response', e, true);\n\n    callback(e);\n    return;\n  }\n\n  callback(null, tokenResponse);\n};\n\nOAuth2Client.prototype._handleGetDeviceCodeResponse = function (response, body, callback) {\n  var deviceCodeResponse;\n\n  try {\n    deviceCodeResponse = this._validateDeviceCodeResponse(body);\n  } catch (e) {\n    this._log.error('Error validating get user code response', e, true);\n\n    callback(e);\n    return;\n  }\n\n  callback(null, deviceCodeResponse);\n};\n\nOAuth2Client.prototype._getTokenWithPolling = function (postOptions, callback) {\n  var self = this;\n\n  if (self._cancelPollingRequest === true) {\n    callback(null, new Error('Polling_Request_Cancelled'));\n    return;\n  }\n\n  request.post(postOptions, util.createRequestHandler('Get Token', this._log, function (response, body) {\n    //error response callback, for error response, it's already parsed as Json. \n    if (body && body.hasOwnProperty(TokenResponseFields.ERROR) && body[TokenResponseFields.ERROR] === 'authorization_pending') {\n      callback(new Error(body[TokenResponseFields.ERROR]), body);\n    } else {\n      callback(null, body);\n    }\n  }, // success response callback\n  function (response, body) {\n    var tokenResponse;\n\n    try {\n      tokenResponse = self._handlePollingResponse(body);\n    } catch (e) {\n      self._log.error('Error validating get token response', e, true);\n\n      callback(null, e);\n      return;\n    }\n\n    callback(null, tokenResponse);\n  }));\n};\n\nOAuth2Client.prototype._createPostOption = function (postUrl, urlEncodedRequestForm) {\n  var postOptions = util.createRequestOptions(this, {\n    'url': url.format(postUrl),\n    body: urlEncodedRequestForm,\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded'\n    },\n    followRedirect: false,\n    encoding: 'utf8'\n  });\n  return postOptions;\n};\n/**\n * @callback GetTokenCallback\n * @memberOf OAuth2Client\n * @param {Error} [error] In case of an error this will hold the associated Error object.\n * @param {TokenResponse} tokenResponse Contains the parsed result of a get token request.\n */\n\n/**\n* @param {object}                           oauthParameters     An object whose keys come from\n*                                                               Constants.OAuth2.Parameters\n* @param {OAuth2Client.GetTokenCallback}   callback            The callback function.\n*/\n\n\nOAuth2Client.prototype.getToken = function (oauthParameters, callback) {\n  var self = this;\n\n  var tokenUrl = self._createTokenUrl();\n\n  var urlEncodedTokenRequestForm = querystring.stringify(oauthParameters);\n\n  var postOptions = self._createPostOption(tokenUrl, urlEncodedTokenRequestForm);\n\n  request.post(postOptions, util.createRequestHandler('Get Token', this._log, callback, function (response, body) {\n    self._handleGetTokenResponse(response, body, callback);\n  }));\n};\n/**\n * @param {object}                          oauthParameters     An object whose keys come from\n *                                                               Constants.OAuth2.Parameters\n * @param {integer}                         refresh_interval    The interval for polling request. \n * @param {integer}                         exipres_in          The timeout for polling request. \n * @param {OAuth2Client.GetTokenCallback}   callback            The callback function.\n */\n\n\nOAuth2Client.prototype.getTokenWithPolling = function (oauthParameters, refresh_interval, expires_in, callback) {\n  var self = this;\n  var maxTimesForRetry = Math.floor(expires_in / refresh_interval);\n\n  var tokenUrl = self._createTokenUrl();\n\n  var urlEncodedTokenRequestForm = querystring.stringify(oauthParameters);\n\n  var postOptions = self._createPostOption(tokenUrl, urlEncodedTokenRequestForm);\n\n  var optionsForRetry = {\n    times: maxTimesForRetry,\n    interval: refresh_interval * 1000\n  };\n  async.retry(optionsForRetry, function (retryCallback, response) {\n    self._getTokenWithPolling(postOptions, retryCallback);\n  }, function (err, response) {\n    if (response && response instanceof Error) {\n      callback(response);\n      return;\n    } else if (response && response.hasOwnProperty(DeviceCodeResponseParameters.ERROR)) {\n      callback(response);\n      return;\n    }\n\n    callback(err, response);\n  });\n};\n\nOAuth2Client.prototype.getUserCodeInfo = function (oauthParameters, callback) {\n  // for now make it as a post request\n  var self = this;\n\n  var deviceCodeUrl = self._createDeviceCodeUrl();\n\n  var urlEncodedDeviceCodeRequestForm = querystring.stringify(oauthParameters);\n\n  var postOptions = self._createPostOption(deviceCodeUrl, urlEncodedDeviceCodeRequestForm);\n\n  request.post(postOptions, util.createRequestHandler('Get Device Code ', this._log, callback, function (response, body) {\n    self._handleGetDeviceCodeResponse(response, body, callback);\n  }));\n};\n/**\n * Cancel the polling request made for acquiring token by device code. \n */\n\n\nOAuth2Client.prototype.cancelPollingRequest = function () {\n  this._cancelPollingRequest = true;\n};\n\nmodule.exports = OAuth2Client;","map":{"version":3,"sources":["C:/Users/chant/Desktop/Bakery_ReactjsSourceCode/node_modules/adal-node/lib/oauth2client.js"],"names":["_","require","querystring","uuid","request","url","async","constants","Logger","util","OAuth2Parameters","OAuth2","Parameters","OAuth2ResponseParameters","ResponseParameters","DeviceCodeResponseParameters","IdTokenMap","TokenResponseFields","UserCodeResponseFields","IdTokenFields","TOKEN_RESPONSE_MAP","TOKEN_TYPE","ACCESS_TOKEN","REFRESH_TOKEN","CREATED_ON","EXPIRES_ON","EXPIRES_IN","RESOURCE","ERROR","ERROR_DESCRIPTION","DEVICE_CODE_RESPONSE_MAP","DEVICE_CODE","USER_CODE","VERIFICATION_URL","INTERVAL","MESSAGE","OAuth2Client","callContext","authority","_aadApiVersion","aadApiVersion","undefined","_tokenEndpoint","tokenEndpoint","_deviceCodeEndpoint","deviceCodeEndpoint","_log","_logContext","_callContext","_cancelPollingRequest","prototype","_createTokenUrl","tokenUrl","parse","parameters","AAD_API_VERSION","search","stringify","_createDeviceCodeUrl","deviceCodeUrl","_parseOptionalInts","obj","keys","self","forEach","element","has","parseInt","isNaN","createError","_crackJwt","jwtToken","idTokenPartsRegex","matches","exec","length","warn","crackedToken","header","JWSPayload","JWSSig","_getUserId","idToken","userId","isDisplayable","upn","email","sub","v4","userIdVals","USER_ID","IS_USER_ID_DISPLAYABLE","mapFields","inObj","outObj","map","key","mappedKey","_extractIdTokenValues","extractedValues","extend","_parseIdToken","encodedIdToken","base64IdToken","base64Decoded","base64DecodeStringUrlSafe","JSON","err","stack","_validateTokenResponse","body","wireResponse","tokenResponse","e","Error","intKeys","expiresIn","now","Date","add","seconds","tempDate","createdOn","setTime","ID_TOKEN","_validateDeviceCodeResponse","deviceCodeResponse","_handlePollingResponse","_handlePollingRequestErrorResponse","isEmpty","_handleGetTokenResponse","response","callback","error","_handleGetDeviceCodeResponse","_getTokenWithPolling","postOptions","post","createRequestHandler","hasOwnProperty","_createPostOption","postUrl","urlEncodedRequestForm","createRequestOptions","format","headers","followRedirect","encoding","getToken","oauthParameters","urlEncodedTokenRequestForm","getTokenWithPolling","refresh_interval","expires_in","maxTimesForRetry","Math","floor","optionsForRetry","times","interval","retry","retryCallback","getUserCodeInfo","urlEncodedDeviceCodeRequestForm","cancelPollingRequest","module","exports"],"mappings":"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","sourcesContent":["/*\n * @copyright\n * Copyright © Microsoft Open Technologies, Inc.\n *\n * All Rights Reserved\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http: *www.apache.org/licenses/LICENSE-2.0\n *\n * THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS\n * OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION\n * ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A\n * PARTICULAR PURPOSE, MERCHANTABILITY OR NON-INFRINGEMENT.\n *\n * See the Apache License, Version 2.0 for the specific language\n * governing permissions and limitations under the License.\n */\n'use strict';\n\nvar _ = require('underscore');\nrequire('date-utils');  // Adds a number of convenience methods to the builtin Date object.\nvar querystring = require('querystring');\nvar uuid = require('uuid');\nvar request = require('request');\nvar url = require('url');\nvar async = require('async');\n\nvar constants = require('./constants');\nvar Logger = require('./log').Logger;\nvar util = require('./util');\n\nvar OAuth2Parameters = constants.OAuth2.Parameters;\nvar OAuth2ResponseParameters = constants.OAuth2.ResponseParameters;\nvar DeviceCodeResponseParameters = constants.OAuth2.DeviceCodeResponseParameters;\nvar IdTokenMap = constants.OAuth2.IdTokenMap;\nvar TokenResponseFields = constants.TokenResponseFields;\nvar UserCodeResponseFields = constants.UserCodeResponseFields;\nvar IdTokenFields = constants.IdTokenFields;\n\nvar TOKEN_RESPONSE_MAP = {};\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.TOKEN_TYPE] = TokenResponseFields.TOKEN_TYPE;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ACCESS_TOKEN] = TokenResponseFields.ACCESS_TOKEN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.REFRESH_TOKEN] = TokenResponseFields.REFRESH_TOKEN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.CREATED_ON] = TokenResponseFields.CREATED_ON;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.EXPIRES_ON] = TokenResponseFields.EXPIRES_ON;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.EXPIRES_IN] = TokenResponseFields.EXPIRES_IN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.RESOURCE] = TokenResponseFields.RESOURCE;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ERROR] = TokenResponseFields.ERROR;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ERROR_DESCRIPTION] = TokenResponseFields.ERROR_DESCRIPTION;\n\n\nvar DEVICE_CODE_RESPONSE_MAP = {};\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.DEVICE_CODE] = UserCodeResponseFields.DEVICE_CODE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.USER_CODE] = UserCodeResponseFields.USER_CODE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.VERIFICATION_URL] = UserCodeResponseFields.VERIFICATION_URL;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.INTERVAL] = UserCodeResponseFields.INTERVAL;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.EXPIRES_IN] = UserCodeResponseFields.EXPIRES_IN;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.MESSAGE] = UserCodeResponseFields.MESSAGE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.ERROR] = UserCodeResponseFields.ERROR;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.ERROR_DESCRIPTION] = UserCodeResponseFields.ERROR_DESCRIPTION;\n\n/**\n * Constructs an instances of OAuth2Client\n * @constructor\n * @private\n * @param {object} callContext Contains any context information that applies to the request.\n * @param {string|url} authority  An url that points to an authority.\n */\nfunction OAuth2Client(callContext, authority) {\n  this._aadApiVersion = authority.aadApiVersion === undefined? '1.0' : authority.aadApiVersion;\n  this._tokenEndpoint = authority.tokenEndpoint;\n  this._deviceCodeEndpoint = authority.deviceCodeEndpoint;\n\n  this._log = new Logger('OAuth2Client', callContext._logContext);\n  this._callContext = callContext;\n  this._cancelPollingRequest = false;\n}\n\n/**\n * Constructs an OAuth 2.0 token request url.\n * @private\n * @return {URL}\n */\nOAuth2Client.prototype._createTokenUrl = function () {\n  var tokenUrl = url.parse(this._tokenEndpoint);\n\n  var parameters = {};\n  parameters[OAuth2Parameters.AAD_API_VERSION] = this._aadApiVersion;\n\n  tokenUrl.search = querystring.stringify(parameters);\n  return tokenUrl;\n};\n\n/**\n * Constructs the user code info request url. \n * @private \n * @return {URL}\n */\nOAuth2Client.prototype._createDeviceCodeUrl = function () {\n   var deviceCodeUrl = url.parse(this._deviceCodeEndpoint);\n\n   var parameters = {};\n   parameters[OAuth2Parameters.AAD_API_VERSION] = this._aadApiVersion;\n\n   deviceCodeUrl.search = querystring.stringify(parameters);\n\n   return deviceCodeUrl;\n};\n\n/**\n * @private\n * @param {object}   obj         An object in which integer values may reside.\n * @param {array}    keys        An array of strings that specify keys in which integers may need parsing.\n */\nOAuth2Client.prototype._parseOptionalInts = function (obj, keys) {\n  var self = this;\n  keys.forEach(function(element) {\n    if (_.has(obj, element)) {\n      obj[element] = parseInt(obj[element], 10);\n      if (isNaN(obj[element])) {\n        throw self._log.createError(element + ' could not be parsed as an int.');\n      }\n    }\n  });\n};\n\n/**\n * Parses a JWS encoded JWT into it's three parts.\n * @param  {string} jwtToken The token to parse.\n * @return {object}          The three JWS parts, header, JWSPayload, and JWSSig, or undefined.\n */\nOAuth2Client.prototype._crackJwt = function(jwtToken) {\n  var idTokenPartsRegex = /^([^\\.\\s]*)\\.([^\\.\\s]+)\\.([^\\.\\s]*)$/;\n\n  var matches = idTokenPartsRegex.exec(jwtToken);\n  if (!matches || matches.length < 4) {\n    this._log.warn('The returned id_token is not parseable.');\n    return;\n  }\n\n  var crackedToken = {\n    header : matches[1],\n    JWSPayload : matches[2],\n    JWSSig : matches[3]\n  };\n\n  return crackedToken;\n};\n\n/**\n * Finds the value that should be used as the userId value.\n * @param {object} idToken The id token that parsed.\n * @returns {object} An object with a userId field and maybe a userIdIsDisplayable field.\n */\nOAuth2Client.prototype._getUserId = function(idToken) {\n  var userId;\n  var isDisplayable;\n\n  if (idToken.upn) {\n    userId = idToken.upn;\n    isDisplayable = true;\n  } else if (idToken.email) {\n    userId = idToken.email;\n    isDisplayable = true;\n  } else if (idToken.sub) {\n    userId = idToken.sub;\n  }\n\n  if (!userId) {\n    // generate a random GUID.\n    userId = uuid.v4();\n  }\n\n  var userIdVals = {};\n  userIdVals[IdTokenFields.USER_ID] = userId;\n  if (isDisplayable) {\n    userIdVals[IdTokenFields.IS_USER_ID_DISPLAYABLE] = true;\n  }\n\n  return userIdVals;\n};\n\nfunction mapFields(inObj, outObj, map) {\n  for (var key in inObj) {\n    if (map[key]) {\n      var mappedKey = map[key];\n      outObj[mappedKey] = inObj[key];\n    }\n  }\n}\n\n/**\n * Given a decoded id token off the wire, this function extracts the values that\n * ADAL commonly returns to callers and translates the names to more user\n * friendly names.\n * @param  {Object} idToken A decoded id token.\n * @return {Object}         The set of extracted values with their new names.\n */\nOAuth2Client.prototype._extractIdTokenValues = function(idToken) {\n  var extractedValues = {};\n  _.extend(extractedValues, this._getUserId(idToken));\n\n  mapFields(idToken, extractedValues, IdTokenMap);\n\n  return extractedValues;\n};\n\n/**\n * Parses the value of the id_token OAuth 2 Reponse.\n * @param  {string} encodedIdToken An unencrypted JWT token.\n * @return {object}                 returns the decoded id_token or undefined.\n */\nOAuth2Client.prototype._parseIdToken = function(encodedIdToken) {\n  var crackedToken = this._crackJwt(encodedIdToken);\n  if (!crackedToken) {\n    return;\n  }\n\n  var idToken;\n  try {\n    var base64IdToken = crackedToken.JWSPayload;\n    var base64Decoded = util.base64DecodeStringUrlSafe(base64IdToken);\n    if (!base64Decoded) {\n      this._log.warn('The returned id_token could not be base64 url safe decoded.');\n      return;\n    }\n\n    idToken = JSON.parse(base64Decoded);\n  } catch (err) {\n    this._log.warn('the returned id_token could not be decoded');\n    this._log.warn('The returned id_token could not be decoded: ' + err.stack, true);\n    return;\n  }\n\n  return this._extractIdTokenValues(idToken);\n};\n\n/**\n * Validates the response returned from an OAuth 2.0 token request.\n * @private\n * @param  {string} body  The response as a string encoded JSON object.\n * @return {object}       The parsed response.\n */\nOAuth2Client.prototype._validateTokenResponse = function(body) {\n  var wireResponse;\n  var tokenResponse = {};\n\n  try {\n    wireResponse = JSON.parse(body);\n  } catch(e) {\n    throw new Error('The token response returned from the server is unparseable as JSON');\n  }\n\n  var intKeys = [\n    OAuth2ResponseParameters.EXPIRES_ON,\n    OAuth2ResponseParameters.EXPIRES_IN,\n    OAuth2ResponseParameters.CREATED_ON\n  ];\n\n  this._parseOptionalInts(wireResponse, intKeys);\n\n  if (wireResponse[OAuth2ResponseParameters.EXPIRES_IN]) {\n    var expiresIn = wireResponse[OAuth2ResponseParameters.EXPIRES_IN];\n    var now = new Date();\n    wireResponse[OAuth2ResponseParameters.EXPIRES_ON] = now.add( { seconds : expiresIn });\n  }\n\n  if (wireResponse[OAuth2ResponseParameters.CREATED_ON]) {\n    var tempDate = new Date();\n    var createdOn = wireResponse[OAuth2ResponseParameters.CREATED_ON];\n    tempDate.setTime(createdOn);\n    wireResponse[OAuth2ResponseParameters.CREATED_ON] = tempDate;\n  }\n\n  if (!wireResponse[OAuth2ResponseParameters.TOKEN_TYPE]) {\n    throw this._log.createError('wireResponse is missing token_type');\n  }\n  if (!wireResponse[OAuth2ResponseParameters.ACCESS_TOKEN]) {\n    throw this._log.createError('wireResponse missing access_token');\n  }\n  \n  mapFields(wireResponse, tokenResponse, TOKEN_RESPONSE_MAP);\n\n  if (wireResponse[OAuth2ResponseParameters.ID_TOKEN]) {\n    var idToken = this._parseIdToken(wireResponse[OAuth2ResponseParameters.ID_TOKEN]);\n    if (idToken) {\n      _.extend(tokenResponse, idToken);\n    }\n  }\n\n  return tokenResponse;\n};\n\n/**\n * Validates the response returned from an OAuth 2.0 device code request.\n * @private\n * @param  {string} body  The response as a string encoded JSON object.\n * @return {object}       The parsed response.\n */\nOAuth2Client.prototype._validateDeviceCodeResponse = function(body) {\n   var wireResponse;\n   var deviceCodeResponse = {};\n\n   try {\n      wireResponse = JSON.parse(body);\n   } catch(e) {\n      throw new Error('The device code response returned from the server is unparseable as JSON.');\n   }\n\n   var intKeys = [\n        DeviceCodeResponseParameters.EXPIRES_IN, \n        DeviceCodeResponseParameters.INTERVAL\n   ];\n\n   this._parseOptionalInts(wireResponse, intKeys);\n  \n   if (!wireResponse[DeviceCodeResponseParameters.EXPIRES_IN]){\n      throw this._log.createError('wireResponse is missing expires_in');\n   }\n\n   if (!wireResponse[DeviceCodeResponseParameters.DEVICE_CODE]) {\n      throw this._log.createError('wireResponse is missing device code');\n   }\n\n   if (!wireResponse[DeviceCodeResponseParameters.USER_CODE]) {\n      throw this._log.createError('wireResponse is missing user code');\n   }\n\n   mapFields(wireResponse, deviceCodeResponse, DEVICE_CODE_RESPONSE_MAP);\n\n   return deviceCodeResponse;\n};\n\n/**\n * @private\n * @param {string}                   body        The body of a http token response.\n */\nOAuth2Client.prototype._handlePollingResponse = function(body) {\n    //handle token error response\n    var tokenResponse = this._handlePollingRequestErrorResponse(body);\n    if (_.isEmpty(tokenResponse)){\n       tokenResponse = this._validateTokenResponse(body);\n    }\n\n    return tokenResponse;\n};\n\n/**\n * @private\n * @param {string}                   body        The body of a http token response.\n */\nOAuth2Client.prototype._handlePollingRequestErrorResponse = function(body) {\n   var wireResponse;\n   var tokenResponse = {};\n\n   try {\n      wireResponse = JSON.parse(body);\n   } catch (e) {\n      throw new Error ('The token response returned from the server is unparsable as JSON');\n   }\n\n   if (wireResponse[OAuth2ResponseParameters.ERROR]) {\n      mapFields(wireResponse, tokenResponse, TOKEN_RESPONSE_MAP);\n   }\n\n   return tokenResponse;\n};\n\n/**\n * @private\n * @param {object}                   response    An http response object.\n * @param {string}                   body        The body of a http token response.\n * @param {OAuth2Client.GetTokenCallback}    callback    A call back function.  The body parameter is the body parameter passed\n *                                               into this function.\n */\nOAuth2Client.prototype._handleGetTokenResponse = function(response, body, callback) {\n  var tokenResponse;\n  try {\n    tokenResponse = this._validateTokenResponse(body);\n  } catch (e) {\n    this._log.error('Error validating get token response', e, true);\n    callback(e);\n    return;\n  }\n  callback(null, tokenResponse);\n};\n\nOAuth2Client.prototype._handleGetDeviceCodeResponse = function(response, body, callback) {\n   var deviceCodeResponse;\n   try {\n      deviceCodeResponse = this._validateDeviceCodeResponse(body);\n   } catch (e) {\n      this._log.error('Error validating get user code response', e, true);\n      callback(e);\n      return;\n   }\n\n   callback(null, deviceCodeResponse);\n};\n\nOAuth2Client.prototype._getTokenWithPolling = function (postOptions, callback) {\n    var self = this;\n    if (self._cancelPollingRequest === true) {\n        callback(null, new Error('Polling_Request_Cancelled'));\n        return;\n    }\n    \n    request.post(postOptions, util.createRequestHandler('Get Token', this._log, function(response, body) {\n        //error response callback, for error response, it's already parsed as Json. \n        if (body && body.hasOwnProperty(TokenResponseFields.ERROR) && body[TokenResponseFields.ERROR] === 'authorization_pending') {\n            callback(new Error(body[TokenResponseFields.ERROR]), body);\n        }\n        else {\n            callback(null, body);\n        }\n       }, \n       // success response callback\n       function (response, body) {\n          var tokenResponse;\n          try {\n             tokenResponse = self._handlePollingResponse(body);\n          } catch (e) {\n             self._log.error('Error validating get token response', e, true);\n             callback(null, e);\n             return;\n          }\n        \n          callback(null, tokenResponse);\n       })\n    );\n};\n\nOAuth2Client.prototype._createPostOption = function (postUrl, urlEncodedRequestForm) {\n    var postOptions = util.createRequestOptions(\n        this,\n    {\n            'url' : url.format(postUrl),\n            body : urlEncodedRequestForm,\n            headers: {\n                'Content-Type': 'application/x-www-form-urlencoded'\n            },\n            followRedirect : false,\n            encoding : 'utf8'\n        }\n    );\n    \n    return postOptions;\n};\n\n/**\n * @callback GetTokenCallback\n * @memberOf OAuth2Client\n * @param {Error} [error] In case of an error this will hold the associated Error object.\n * @param {TokenResponse} tokenResponse Contains the parsed result of a get token request.\n */\n\n/**\n* @param {object}                           oauthParameters     An object whose keys come from\n*                                                               Constants.OAuth2.Parameters\n* @param {OAuth2Client.GetTokenCallback}   callback            The callback function.\n*/\nOAuth2Client.prototype.getToken = function(oauthParameters, callback) {\n  var self = this;\n  var tokenUrl = self._createTokenUrl();\n\n  var urlEncodedTokenRequestForm = querystring.stringify(oauthParameters);\n\n  var postOptions = self._createPostOption(tokenUrl, urlEncodedTokenRequestForm);\n\n  request.post(postOptions, util.createRequestHandler('Get Token', this._log, callback,\n    function (response, body) {\n      self._handleGetTokenResponse(response, body, callback);\n    })\n  );\n};\n\n/**\n * @param {object}                          oauthParameters     An object whose keys come from\n *                                                               Constants.OAuth2.Parameters\n * @param {integer}                         refresh_interval    The interval for polling request. \n * @param {integer}                         exipres_in          The timeout for polling request. \n * @param {OAuth2Client.GetTokenCallback}   callback            The callback function.\n */\nOAuth2Client.prototype.getTokenWithPolling = function(oauthParameters, refresh_interval, expires_in, callback){\n   var self = this; \n   var maxTimesForRetry = Math.floor(expires_in / refresh_interval);\n  \n   var tokenUrl = self._createTokenUrl();\n   var urlEncodedTokenRequestForm = querystring.stringify(oauthParameters);\n   var postOptions = self._createPostOption(tokenUrl, urlEncodedTokenRequestForm);\n\n   var optionsForRetry = {times: maxTimesForRetry, interval: refresh_interval * 1000};\n\n   async.retry(optionsForRetry, function(retryCallback, response) {\n      self._getTokenWithPolling(postOptions, retryCallback);\n   }, function(err, response) {\n      if (response && response instanceof Error) {\n         callback(response);\n         return;\n      }\n      else if (response && response.hasOwnProperty(DeviceCodeResponseParameters.ERROR)) {\n         callback(response);\n         return;\n      }\n      callback(err, response);\n   });\n};\n\nOAuth2Client.prototype.getUserCodeInfo = function(oauthParameters, callback) {\n    // for now make it as a post request\n    var self = this;\n    var deviceCodeUrl = self._createDeviceCodeUrl();\n\n    var urlEncodedDeviceCodeRequestForm = querystring.stringify(oauthParameters);\n    \n    var postOptions = self._createPostOption(deviceCodeUrl, urlEncodedDeviceCodeRequestForm);\n\n    request.post(postOptions, util.createRequestHandler('Get Device Code ', this._log, callback,\n       function (response, body) {\n          self._handleGetDeviceCodeResponse(response, body, callback);\n       })\n    );\n};\n\n/**\n * Cancel the polling request made for acquiring token by device code. \n */\nOAuth2Client.prototype.cancelPollingRequest = function() {\n   this._cancelPollingRequest = true;\n};\n\nmodule.exports = OAuth2Client;\n"]},"metadata":{},"sourceType":"script"}